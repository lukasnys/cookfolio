---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";

const recipes = await getCollection("recipes");
const sorted = recipes.sort((a, b) => a.data.title.localeCompare(b.data.title));
---

<BaseLayout title="Recipes">
  <div class="mb-10">
    <h1 class="font-display text-5xl mb-2">Recipes</h1>
    <p class="text-text-secondary text-lg">{sorted.length} recipes in the collection</p>
  </div>

  <input
    id="recipe-search"
    type="search"
    placeholder="Search recipes..."
    aria-label="Search recipes"
    class="mb-6 w-full"
  />

  <div id="recipe-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    {
      sorted.map((recipe) => (
        <a
          href={`${import.meta.env.BASE_URL}recipes/${recipe.id}/`}
          class="group block rounded-xl border border-border bg-bg-surface/50 px-5 py-4 transition-all hover:border-accent/30 hover:bg-accent-subtle hover:shadow-sm"
          data-search={`${recipe.data.title} ${recipe.data.category}`.toLowerCase()}
        >
          <span class="font-display text-lg font-medium text-text group-hover:text-accent transition-colors">
            {recipe.data.title}
          </span>
          {recipe.data.category !== "main" && (
            <span class="ml-2 inline-block rounded-full bg-bg-elevated px-2 py-0.5 text-xs font-medium text-text-muted">
              {recipe.data.category}
            </span>
          )}
        </a>
      ))
    }
  </div>

  <p id="no-results" class="hidden mt-6 text-center text-text-muted" role="status" aria-live="polite">
    No recipes found.
  </p>

  <script>
    const search = document.getElementById("recipe-search") as HTMLInputElement;
    const grid = document.getElementById("recipe-grid")!;
    const cards = grid.querySelectorAll<HTMLAnchorElement>("a[data-search]");
    const noResults = document.getElementById("no-results")!;

    window.addEventListener("pageshow", () => {
      search.value = "";
    });

    search.addEventListener("input", () => {
      const query = search.value.toLowerCase().trim();
      let visible = 0;

      for (const card of cards) {
        const match = !query || card.dataset.search!.includes(query);
        card.style.display = match ? "" : "none";
        if (match) visible++;
      }

      noResults.classList.toggle("hidden", visible > 0);
    });
  </script>
</BaseLayout>
